name: Ubuntu

on:
  workflow_dispatch:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-libnacs:
    name: Build libnacs
    runs-on: ubuntu-${{matrix.UBUNTU_VER}}
    strategy:
      fail-fast: false
      matrix:
        include:
          - UBUNTU_VER: 18.04
            LLVM_VER: 10
          - UBUNTU_VER: 20.04
            LLVM_VER: 11

    env:
      DEB_REL: 0ubuntu1

    steps:
    - uses: actions/checkout@v2
      with:
        repository: nacs-lab/libnacs
        ref: seq

    - name: Install dependencies
      run: sudo apt-get install libopenlibm-dev ${{matrix.UBUNTU_VER != '18.04' && 'libsleef-dev' || ''}} libzmq3-dev libyaml-cpp-dev libtbb-dev llvm-${{matrix.LLVM_VER}}-dev

    - name: Fix zmq include path
      if: ${{matrix.UBUNTU_VER == '18.04'}} # zmq returns a non-existing include path
      run: sudo mkdir -p /usr/lib/x86_64-linux-gnu/pgm-5.2/include

    - name: Configure CMake
      run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=Release -DENABLE_SIMD=${{matrix.UBUNTU_VER != '18.04' && 'On' || 'Off'}} -DENABLE_LLVM=On -DENABLE_TESTING=Off -DCPACK_DEBIAN_PACKAGE_RELEASE=${{env.DEB_REL}}

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config Release -j $(nproc)

    - name: Create package
      run: |
        cd ${{github.workspace}}/build
        cpack ..

    - name: "Upload binaries"
      uses: actions/upload-artifact@v2
      with:
        name: libnacs-git-package-ubuntu-${{matrix.UBUNTU_VER}}
        path: ${{github.workspace}}/build/libnacs*.deb

  build-python-libnacs:
    name: Build python-libnacs
    needs: build-libnacs
    runs-on: ubuntu-${{matrix.UBUNTU_VER}}
    strategy:
      fail-fast: false
      matrix:
        include:
          - UBUNTU_VER: 18.04
            LLVM_VER: 10
          - UBUNTU_VER: 20.04
            LLVM_VER: 11

    env:
      DEB_REL: 0ubuntu1

    steps:
    - uses: actions/checkout@v2
      with:
        repository: nacs-lab/python-libnacs
        ref: seq

    - name: Install dependencies
      run: sudo apt-get install libopenlibm-dev ${{matrix.UBUNTU_VER != '18.04' && 'libsleef-dev' || ''}} libzmq3-dev libyaml-cpp-dev libtbb-dev llvm-${{matrix.LLVM_VER}}-dev python3

    - name: Download libnacs
      uses: actions/download-artifact@v2
      with:
        name: libnacs-git-package-ubuntu-${{matrix.UBUNTU_VER}}
        path: libnacs-package

    - name: Install libnacs
      run: sudo dpkg -i libnacs-package/*.deb

    - name: Configure CMake
      run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=Release -DPYTHON_EXECUTABLE=/usr/bin/python3 -DCPACK_DEBIAN_PACKAGE_RELEASE=${{env.DEB_REL}}

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config Release -j $(nproc)

    - name: Create package
      run: |
        cd ${{github.workspace}}/build
        cpack ..

    - name: "Upload binaries"
      uses: actions/upload-artifact@v2
      with:
        name: python-libnacs-git-package-ubuntu-${{matrix.UBUNTU_VER}}
        path: ${{github.workspace}}/build/python-libnacs*.deb

  build-labctrl-node:
    name: Build labctrl-node
    needs: build-libnacs
    runs-on: ubuntu-${{matrix.UBUNTU_VER}}
    strategy:
      fail-fast: false
      matrix:
        include:
          - UBUNTU_VER: 18.04
            LLVM_VER: 10
            NODE_VER: 14
          - UBUNTU_VER: 20.04
            LLVM_VER: 11
            NODE_VER: 14
          - UBUNTU_VER: 18.04
            LLVM_VER: 10
            NODE_VER: 16
          - UBUNTU_VER: 20.04
            LLVM_VER: 11
            NODE_VER: 16

    env:
      DEB_REL: 0ubuntu1~node${{matrix.NODE_VER}}

    steps:
    - uses: actions/checkout@v2
      with:
        repository: nacs-lab/labctrl-node
        ref: seq

    - name: Install dependencies
      run: sudo apt-get install libopenlibm-dev ${{matrix.UBUNTU_VER != '18.04' && 'libsleef-dev' || ''}} libzmq3-dev libyaml-cpp-dev libtbb-dev llvm-${{matrix.LLVM_VER}}-dev

    - name: Install NodeJS
      run: |
        curl -fsSL https://deb.nodesource.com/setup_${{matrix.NODE_VER}}.x | sudo -E bash -
        sudo apt-get install -y nodejs

    - name: Download libnacs
      uses: actions/download-artifact@v2
      with:
        name: libnacs-git-package-ubuntu-${{matrix.UBUNTU_VER}}
        path: libnacs-package

    - name: Install libnacs
      run: sudo dpkg -i libnacs-package/*.deb

    - name: Configure CMake
      run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=Release -DCPACK_DEBIAN_PACKAGE_RELEASE=${{env.DEB_REL}}

    - name: Build
      run: |
        cmake --build ${{github.workspace}}/build --config Release -j $(nproc)
        make -C ${{github.workspace}}/build deploy -j $(nproc)

    - name: Create package
      run: |
        cd ${{github.workspace}}/build
        cpack ..

    - name: "Upload binaries"
      uses: actions/upload-artifact@v2
      with:
        name: labctrl-node-git-nodejs${{matrix.NODE_VER}}-package-ubuntu-${{matrix.UBUNTU_VER}}
        path: ${{github.workspace}}/build/labctrl-node*.deb
