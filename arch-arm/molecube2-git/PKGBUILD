pkgname=molecube2-git
pkgver=63.8cebb8e
pkgrel=1
pkgdesc='NaCs control'
arch=('armv7h')
url='harvard.edu'
license=('LGPL')
options=('!strip' 'debug')
makedepends=('cmake' 'clang' 'arm-linux-gnueabihf-gcc' 'arch-arm')
source=("git://github.com/nacs-lab/molecube2")
md5sums=('SKIP')

pkgver() {
  cd molecube2

  echo "$(git rev-list --count HEAD).$(git rev-parse --short HEAD)"
}

build() {
  cd molecube2

  CFLAGS=${CFLAGS/-fvar-tracking-assignments/}
  CXXFLAGS=${CXXFLAGS/-fvar-tracking-assignments/}

  CFLAGS=${CFLAGS/-march=armv7-a/}
  CXXFLAGS=${CXXFLAGS/-march=armv7-a/}

  CFLAGS+=' -O2 -flto'
  CXXFLAGS+=' -O2 -flto'
  LDFLAGS+=' -O2 -flto'

  mkdir -p build
  cd build
  cmake .. -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_TOOLCHAIN_FILE=/usr/share/cmake/Modules/ARMv7hf.cmake \
        -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_INSTALL_LIBDIR=/usr/lib \
        -DCMAKE_INSTALL_BINDIR=/usr/bin -DCMAKE_INSTALL_DATADIR=/usr/share
  make
}

package() {
  depends=('glibc' 'libnacs' 'zeromq')
  cd molecube2/build

  make install DESTDIR="${pkgdir}"
}
