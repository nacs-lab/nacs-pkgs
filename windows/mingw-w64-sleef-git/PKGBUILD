# Maintainer: Alexey Pavlov <alexpux@gmail.com>
# Contributor: JÃ¼rgen Pfeifer <juergen@familiepfeifer.de>

pkgbase=mingw-w64-sleef-git
pkgname="${MINGW_PACKAGE_PREFIX}-sleef-git"
pkgrel=1
pkgver=3.3.1.38.gca4fd10
pkgdesc="SIMD Library for Evaluating Elementary Functions, vectorized libm and DFT (mingw-w64)"
provides=("${MINGW_PACKAGE_PREFIX}-sleef")
arch=('any')
url="http://sleef.org/"
license=('custom')
provides=("${MINGW_PACKAGE_PREFIX}-sleef")
conflicts=("${MINGW_PACKAGE_PREFIX}-sleef")
replaces=("${MINGW_PACKAGE_PREFIX}-sleef")
options=('strip' 'staticlibs')
depends=("${MINGW_PACKAGE_PREFIX}-gcc-libs"
         "${MINGW_PACKAGE_PREFIX}-libwinpthread")
makedepends=("git"
             "${MINGW_PACKAGE_PREFIX}-clang"
             "${MINGW_PACKAGE_PREFIX}-cmake")
source=("git://github.com/shibatch/sleef"
        0001-Use-vector-calling-convention.patch)
sha256sums=('SKIP'
            '7581cc1f2f5b2fa573257bd4b7c57bb23fd561b463ed97d761241aa6e482c98e')

pkgver() {
  cd sleef

  git describe --tags | sed -e 's/-/./g'
}

prepare() {
  cd sleef

  git reset --hard HEAD
  git clean -fdx

  patch -Np1 < ../0001-Use-vector-calling-convention.patch
}

build() {
  cd sleef

  mkdir -p build
  cd build

  CC=${MINGW_PREFIX}/bin/clang CXX=${MINGW_PREFIX}/bin/clang++ \
    MSYS2_ARG_CONV_EXCL="-DCMAKE_INSTALL_PREFIX=" "${MINGW_PREFIX}"/bin/cmake .. \
    -G"MSYS Makefiles" -DCMAKE_BUILD_TYPE=RelWithDebInfo \
    -DCMAKE_INSTALL_PREFIX="${MINGW_PREFIX}"
  make
}

package() {
  cd sleef/build

  make install DESTDIR="$pkgdir"
  mkdir -p "${pkgdir}${MINGW_PREFIX}/bin"
  mv "${pkgdir}${MINGW_PREFIX}/lib/"libsleef.dll "${pkgdir}${MINGW_PREFIX}/bin/"
}
